    {% load static %}

    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Perfil de Usuario - CrecetuLana</title>
         <link rel="icon" href="{% static '/images/logo_favicon.png' %}" type="image/png">
        <!-- Se mantiene el FontAwesome 5 que usas para consistencia -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
        <!-- Se añade FontAwesome 6 para los iconos de edición más modernos (lápiz, guardar, cámara) -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
        
        <!-- Incluir Tailwind CSS para usar sus clases en el contenido, manteniendo la estructura general con tu CSS -->
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            // Configuración mínima de Tailwind para el color principal
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            'primary': '#4caf50', // Verde de marca
                            'dark-bg': '#2b3e50', // Fondo de la sidebar
                        },
                        fontFamily: {
                            sans: ['Arial', 'sans-serif'],
                            montserrat: ['Montserrat', 'sans-serif'],
                        },
                    }
                }
            }
        </script>
        
        <!-- Tu bloque de estilos personalizados (adaptado para la página de Perfil) -->
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
                display: flex;
                background-color: #f7f7f7; /* Color de fondo ligero */
            }
            .sidebar {
                width: 200px;
                background-color: #2b3e50;
                color: white;
                height: 100vh;
                padding-top: 20px;
                position: fixed;
                z-index: 10;
                box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            }
            .logo-container {
                text-align: center;
                margin-bottom: 20px;
            }
            .logo {
                font-family: 'Montserrat', sans-serif;
                font-size: 24px;
                font-weight: 700;
            }
            .logo .crece { color: white; }
            .logo .tu { color: #4caf50; }
            .logo .lana { color: white; }
            .logo-tagline {
                font-size: 12px;
                color: #4caf50;
                margin-top: 5px;
                line-height: 1.2;
            }
            .sidebar a {
                padding: 12px 15px;
                text-decoration: none;
                color: white;
                display: block;
                font-size: 16px;
                transition: background-color 0.2s;
            }
            .sidebar a:hover {
                background-color: #1b2a38;
            }
            .sidebar .active-link {
                background-color: #1b2a38; /* Resaltar la página activa */
                border-left: 4px solid #4caf50;
                padding-left: 11px;
            }
            .sidebar i {
                margin-right: 8px;
            }
            .disponible-prestamo {
                position: absolute;
                bottom: 28px;
                left: 15px;
                color: white;
            }
            .disponible-prestamo h3 {
                margin: 0;
                font-size: 11px;
                color: #40e0d0;
            }
            .disponible-prestamo .importe {
                font-size: 18px;
                margin-top: 5px;
                color: white;
            }
            .disponible-prestamo .leyenda {
                font-size: 11px;
                color: #a9c1d9;
            }
            .content {
                margin-left: 200px;
                padding: 20px;
                width: calc(100% - 200px);
                min-height: 100vh;
            }
            /* Clase para ocultar elementos con JS */
            .hidden-js { display: none; }
        </style>
    </head>
    <body>
        
        <!-- 1. Sidebar (Adaptado a tu estructura y CSS) -->
        <div class="sidebar">
            <div class="logo-container">
                <div class="logo">
                    <span class="crece">crece</span><span class="tu">tu</span><span class="lana">Lana</span>
                </div>
                <div class="logo-tagline">
                    Donde tu lana<br>
                    nunca se queda quieta
                </div>
            </div>
            <a href="{% url 'dashboard' %}"><i class="fas fa-chart-pie"></i> Resumen</a>
            <a href="{% url 'lista_movimientos' %}"><i class="fas fa-list"></i> Movimientos</a>
            <!-- Clase activa para el perfil -->
            <a href="{% url 'perfil' %}" class="active-link"><i class="far fa-user-circle"></i> Perfil</a>
             {% if usuario.COD_PERMISOS == 99 %}<a href="{% url 'registro' %}"><i class="fas fa-marker"></i> Registrar</a>   {% endif %}
            <a href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</a>

            <div class="disponible-prestamo">
                <h3>Disponible para préstamo:</h3>
                <!-- Se utiliza |floatformat:2 para asegurar dos decimales -->
                <div class="importe">${{ prestamo_disponible|default:"0.00"|floatformat:2 }}</div>
                <div class="leyenda">Tasa del 4% Mensual</div>
            </div>
        </div>

        <!-- 2. Contenido Principal (Usando tu clase .content) -->
        <div class="content">
            {% csrf_token %}

            <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6 sm:p-10">
                
                <h2 class="text-3xl font-extrabold text-gray-800 mb-8 border-b pb-4">Configuración de Perfil</h2>
                
                <!-- Mensajes de Django -->
                {% if messages %}
                    <div class="mb-6">
                        {% for message in messages %}
                            <!-- Se usan clases de Tailwind para dar color a los mensajes -->
                            <div class="p-4 rounded-lg text-white font-semibold mb-2 
                                {% if message.tags == 'success' %}bg-primary{% elif message.tags == 'error' %}bg-red-500{% else %}bg-blue-500{% endif %}" role="alert">
                                {{ message }}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Formulario de Edición (Incluye Correo y Foto) -->
                <form id="perfilForm" method="POST" action="{% url 'perfil' %}" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- SECCIÓN DE FOTO DE PERFIL -->
                    <div class="flex flex-col items-center mb-10 border-b pb-8">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Foto de Perfil</h3>
                        <div class="relative w-32 h-32 mb-4">
                            <!-- Imagen actual del usuario -->
                            <img id="profile-img-preview"
                                class="w-full h-full object-cover rounded-full border-4 border-primary shadow-lg"
                                src="{% if usuario.FOTO_PERFIL %}{{ usuario.FOTO_PERFIL.url }}{% else %}https://placehold.co/128x128/eeeeee/2b3e50?text={{ usuario.COD_USUARIO|slice:":1" }}{% endif %}" 
                                alt="Foto de Perfil">

                            <!-- Botón para subir la foto (Icono de Cámara Font Awesome 6) -->
                            <label for="foto_perfil_input" class="absolute bottom-0 right-0 p-2 bg-primary rounded-full cursor-pointer text-white hover:bg-green-600 transition duration-150 shadow-md">
                                <i class="fas fa-camera text-sm"></i>
                            </label>
                            <input type="file" name="foto_perfil" id="foto_perfil_input" accept="image/*" class="hidden" onchange="previewImage(event); toggleSaveButton(true);">
                        </div>
                        <p class="text-sm text-gray-500">Haz clic en la cámara para subir una nueva imagen.</p>
                    </div>


                    <!-- SECCIÓN DE DATOS PERSONALES -->
                    <div class="space-y-6">
                        <!-- Campo no editable: Código de Usuario -->
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Código de Usuario</label>
                            <p class="text-lg font-semibold text-gray-800 p-2 bg-gray-100 rounded-md border border-gray-200">
                                {{ usuario.COD_USUARIO }}
                            </p>
                        </div>

                        <!-- Campo no editable: Nombre Completo -->
                        <div>
                            <label class="block text-sm font-medium text-gray-500">Nombre Completo</label>
                            <p class="text-lg font-semibold text-gray-800 p-2 bg-gray-100 rounded-md border border-gray-200">
                                {{ nombre }} {{ ape_paterno }} {{ ape_materno }}
                            </p>
                        </div>

                        <!-- Campo Editable: Correo Electrónico -->
                        <div class="relative flex items-center">
                            <div class="flex-1">
                                <label for="correo_input" class="block text-sm font-medium text-gray-500">Correo Electrónico</label>
                                
                                <!-- Modo Lectura -->
                                <span id="correo_display" class="text-lg font-medium text-gray-800 p-2 block border border-transparent rounded-md transition duration-200 hover:bg-gray-50">
                                    {{ usuario.CORREO|default:"No especificado" }}
                                </span>
                                
                                <!-- Modo Edición (Oculto por defecto) -->
                                <input type="email" id="correo_input" name="correo" value="{{ usuario.CORREO|default:"" }}"
                                    class="hidden-js w-full p-2 border border-gray-300 rounded-lg focus:border-primary focus:ring-primary transition duration-150"
                                    placeholder="Introduce tu nuevo correo">
                            </div>
                            
                            <!-- Botón de Edición/Cancelar (Icono de Lápiz/Cancelar Font Awesome 6) -->
                            <button type="button" id="edit_toggle_btn" onclick="toggleEditMode()"
                                    class="ml-4 p-3 rounded-full bg-primary text-white hover:bg-green-600 transition duration-150 shadow-md flex items-center justify-center"
                                    title="Editar Correo">
                                <i id="edit_icon" class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Botón de Guardar Cambios (Inicialmente oculto) -->
                    <div id="save_button_area" class="mt-10 pt-6 border-t hidden-js flex justify-end">
                        <button type="submit"
                                class="flex items-center space-x-2 px-6 py-3 bg-primary text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition duration-200 transform hover:scale-105">
                            <i class="fas fa-save"></i>
                            <span>Guardar Cambios</span>
                        </button>
                    </div>
                </form>

            </div>
        </div>

        <!-- 3. Lógica JavaScript para Interacción (sin cambios) -->
        <script>
            // Estado de la edición
            let isEditing = false;
            const correoDisplay = document.getElementById('correo_display');
            const correoInput = document.getElementById('correo_input');
            const editToggleBtn = document.getElementById('edit_toggle_btn');
            const editIcon = document.getElementById('edit_icon');
            const saveButtonArea = document.getElementById('save_button_area');

            // Función para alternar el modo de edición (solo para el correo)
            function toggleEditMode() {
                isEditing = !isEditing;

                if (isEditing) {
                    // Modo Edición
                    correoDisplay.classList.add('hidden-js');
                    correoInput.classList.remove('hidden-js');
                    correoInput.focus();
                    editIcon.classList.remove('fa-pencil-alt');
                    editIcon.classList.add('fa-times'); // Cambiar a icono de cancelar
                    editToggleBtn.title = "Cancelar Edición";
                    toggleSaveButton(true); // Mostrar botón de guardar
                } else {
                    // Modo Lectura
                    correoDisplay.classList.remove('hidden-js');
                    correoInput.classList.add('hidden-js');
                    // Restaurar el valor mostrado (o el valor original)
                    correoDisplay.textContent = correoInput.value || 'No especificado'; 
                    editIcon.classList.remove('fa-times');
                    editIcon.classList.add('fa-pencil-alt'); // Cambiar a icono de lápiz
                    editToggleBtn.title = "Editar Correo";
                    
                    // Ocultar botón de guardar si no hay foto seleccionada y el correo no ha cambiado
                    const fotoSeleccionada = document.getElementById('foto_perfil_input').files.length > 0;
                    const valorOriginal = '{{ usuario.CORREO|default:"" }}';
                    const valorActual = correoInput.value;
                    
                    if (!fotoSeleccionada && valorActual === valorOriginal) {
                        toggleSaveButton(false);
                    }
                }
            }

            // Función para mostrar/ocultar el botón de guardar
            function toggleSaveButton(show) {
                if (show) {
                    saveButtonArea.classList.remove('hidden-js');
                } else {
                    saveButtonArea.classList.add('hidden-js');
                }
            }

            // Función para previsualizar la imagen y mostrar el botón de guardar
            function previewImage(event) {
                const reader = new FileReader();
                reader.onload = function(){
                    const output = document.getElementById('profile-img-preview');
                    output.src = reader.result;
                }
                reader.readAsDataURL(event.target.files[0]);
            }

            // Event listener para el correo, para mostrar el botón de guardar si el valor cambia
            correoInput.addEventListener('input', () => {
                const valorOriginal = '{{ usuario.CORREO|default:"" }}';
                const valorActual = correoInput.value;
                const fotoSeleccionada = document.getElementById('foto_perfil_input').files.length > 0;
                
                // Mostrar si el correo es diferente al original O si hay una foto seleccionada
                if (valorActual !== valorOriginal || fotoSeleccionada) {
                    toggleSaveButton(true);
                } else {
                    toggleSaveButton(false);
                }
            });
            
            // Inicialización: asegurarse de que el input esté oculto al cargar la página
            document.addEventListener('DOMContentLoaded', () => {
                if (correoInput.value) {
                    correoDisplay.textContent = correoInput.value;
                }
            });

        </script>

    </body>
    </html>
